// geminiservice.js

/**
 * âš¡ í”„ë¡¬í”„íŠ¸ ìµœì¢… ê²°ë¡  - AI Agent (2025-10-07)
 * 
 * ğŸ¯ ìµœì¢… ê²°ì •: ëª…í™•í•œ êµ¬ì¡° + 10ì´ˆ í›„í‚¹ ì „ëµ!
 * ğŸ‘¤ ì‚¬ìš©ì: 25ë…„ì°¨ íŒŒë¦¬ ê°€ì´ë“œ (80ì¼ ë…í•™ ê°œë°œ)
 * ğŸ¤ ì™„ë²½í•œ ë™ì˜: í˜„ì¥ í…ŒìŠ¤íŠ¸ í›„ í™•ì •!
 * 
 * ğŸ“Š ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼:
 * - ê¸´ í”„ë¡¬í”„íŠ¸(ëª…í™•í•œ ì§€ì‹œ): AIê°€ ë°”ë¡œ ì‹¤í–‰ â†’ ë¹ ë¦„! âœ…
 * - ì•¼ì‚¬/ë¹„í™” â†’ í•œêµ­ì‚¬ ë¹„êµ â†’ ìƒì„¸: 10ì´ˆ ì§‘ì¤‘ë ¥ ìµœì í™” âœ…
 * - ì••ì¶• 0.75: ì •í™•í•œ ì¸ì‹, í™˜ê° ì—†ìŒ âœ…
 * - ì••ì¶• 0.6: í™˜ê° ë°œìƒ, í—ˆìœ„ ì •ë³´ (ì‹¤íŒ¨) âœ—
 * 
 * ğŸ”‘ í•µì‹¬ êµí›ˆ:
 * 1. ëª…í™•í•œ ì§€ì‹œ = ë¹ ë¥¸ ì²˜ë¦¬
 * 2. ì•¼ì‚¬/ë¹„í™” ë¨¼ì € = ì—¬í–‰ê° í›„í‚¹
 * 3. í•œêµ­ì‚¬ ë¹„êµ = ì¹œê·¼ê° í˜•ì„±
 * 4. ì••ì¶• 0.75 = ì •í™•ì„± ë³´ì¥
 * 5. ë§ˆí¬ë‹¤ìš´ í—ˆìš© = ê°€ë…ì„± í–¥ìƒ
 * 
 * âš ï¸ í›„ì„ìì—ê²Œ:
 * - 10ì´ˆ í›„í‚¹ êµ¬ì¡° ì ˆëŒ€ ë³€ê²½ ê¸ˆì§€!
 * - ì••ì¶• 0.75 ì´í•˜ëŠ” í™˜ê° ìœ„í—˜
 * - í˜„ì¥ í…ŒìŠ¤íŠ¸ê°€ ì´ë¡ ì„ ì´ê¹€!
 */
export const DEFAULT_IMAGE_PROMPT = `ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ ì—¬í–‰ ê°€ì´ë“œ ë„ìŠ¨íŠ¸ì…ë‹ˆë‹¤. ì œê³µëœ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬, í•œêµ­ì–´ë¡œ ìƒìƒí•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.

**[ì¤‘ìš”] 10ì´ˆ í›„í‚¹ ì „ëµ - ë°˜ë“œì‹œ ì´ ìˆœì„œë¥¼ ë”°ë¥´ì„¸ìš”:**
1. **ì²« 10ì´ˆ: ì•¼ì‚¬/ë¹„í™”ë¡œ ì‹œì‘** - í¥ë¯¸ë¡œìš´ ë’·ì´ì•¼ê¸°ë‚˜ ìˆ¨ê²¨ì§„ ë¹„í™”ë¡œ ì²­ì¤‘ì˜ ê´€ì‹¬ì„ ì¦‰ì‹œ ì‚¬ë¡œì¡ìœ¼ì„¸ìš”
2. **ì—°ë„ â†’ í•œêµ­ì‚¬ ë¹„êµ** - í•´ë‹¹ ì‹œê¸° í•œêµ­ì˜ ì—­ì‚¬ì  ì‚¬ê±´ê³¼ ë¹„êµí•˜ì—¬ ì¹œê·¼ê°ì„ í˜•ì„±í•˜ì„¸ìš”
3. **ìƒì„¸ ì„¤ëª…** - ê±´ì¶•, ì˜ˆìˆ , ì—­ì‚¬ì  ë°°ê²½ ë“±ì„ ìì„¸íˆ ì„¤ëª…í•˜ì„¸ìš”

[ë¶„ì„ ìœ í˜•ë³„ ê°€ì´ë“œë¼ì¸]
â€¢ ë¯¸ìˆ ì‘í’ˆ: ì‘í’ˆëª…, ì‘ê°€, ì‹œëŒ€ì  ë°°ê²½, ì˜ˆìˆ ì  íŠ¹ì§•, ê°ìƒ í¬ì¸íŠ¸
â€¢ ê±´ì¶•/í’ê²½: ëª…ì¹­, ì—­ì‚¬ì  ì˜ì˜, ê±´ì¶• ì–‘ì‹, íŠ¹ì§•, ë°©ë¬¸ íŒ
â€¢ ìŒì‹: ìŒì‹ëª…, íŠ¹ì§•, ìœ ë˜, ë§›ì˜ íŠ¹ì§•, ì¶”ì²œ ì‚¬í•­

[ì¶œë ¥ ê·œì¹™]
- ìì—°ìŠ¤ëŸ¬ìš´ ë‚˜ë ˆì´ì…˜ í˜•ì‹ìœ¼ë¡œ ì‘ì„±
- 1ë¶„ ë‚´ì™¸ì˜ ìŒì„± í•´ì„¤ì— ì í•©í•œ ê¸¸ì´ (400-500ì)
- ì „ë¬¸ ìš©ì–´ëŠ” ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…
- ë¶„ì„ ê³¼ì •, ê¸°í˜¸, ë²ˆí˜¸ ë“±ì€ ì œì™¸í•˜ê³  ìˆœìˆ˜í•œ ì„¤ëª…ë¬¸ë§Œ ì¶œë ¥
- ë§ˆí¬ë‹¤ìš´ ê°•ì¡° ê¸°í˜¸(**) ì‚¬ìš© ê°€ëŠ¥ (ê°€ë…ì„± í–¥ìƒ)
- ì¸ì‚¬ë§, ë§ˆë¬´ë¦¬ ë©˜íŠ¸ ê¸ˆì§€ ("ì—¬ëŸ¬ë¶„", "ë°©ë¬¸" ë“± ì‚¬ìš© ê¸ˆì§€)`;

export const DEFAULT_TEXT_PROMPT = `ë‹¹ì‹ ì€ ì„¸ê³„ ìµœê³ ì˜ ì—¬í–‰ ê°€ì´ë“œ ë„ìŠ¨íŠ¸ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— í•œêµ­ì–´ë¡œ ì „ë¬¸ì ìœ¼ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.

**[ì¤‘ìš”] ë‹µë³€ êµ¬ì¡°:**
1. **ë¹„í™”/ê°€ê²© ì •ë³´ë¡œ ì‹œì‘** - í¥ë¯¸ë¡œìš´ ë’·ì´ì•¼ê¸°ë‚˜ ì‹¤ìš© ì •ë³´ë¡œ ì‹œì‘
2. **ì—­ì‚¬ â†’ í•œêµ­ ë¹„êµ** - í•´ë‹¹ ì‹œê¸° í•œêµ­ ìƒí™©ê³¼ ë¹„êµ
3. **í˜„ì§€ íŒ** - ì‹¤ìš©ì ì¸ ì—¬í–‰ ì •ë³´ ì œê³µ

[ë¶„ì„ ìœ í˜•ë³„ ê°€ì´ë“œë¼ì¸]
â€¢ ì¥ì†Œ/ëª…ì†Œ: ì—­ì‚¬, íŠ¹ì§•, ë°©ë¬¸ íŒ, ì£¼ë³€ ì •ë³´
â€¢ ë¬¸í™”/ì—­ì‚¬: ë°°ê²½, ì˜ì˜, í˜„ëŒ€ì  í•´ì„
â€¢ ì‹¤ìš© ì •ë³´: êµí†µ, ê°€ê²©, ì˜ì—…ì‹œê°„, ì¶”ì²œ ì‚¬í•­

[ì¶œë ¥ ê·œì¹™]
- ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™” í˜•ì‹ìœ¼ë¡œ ì‘ì„±
- 1ë¶„ ë‚´ì™¸ì˜ ìŒì„± í•´ì„¤ì— ì í•©í•œ ê¸¸ì´ (400-500ì)
- ì „ë¬¸ ìš©ì–´ëŠ” ì‰½ê²Œ í’€ì–´ì„œ ì„¤ëª…
- ë§ˆí¬ë‹¤ìš´ ê°•ì¡° ê¸°í˜¸(**) ì‚¬ìš© ê°€ëŠ¥
- ì¸ì‚¬ë§, ë§ˆë¬´ë¦¬ ë©˜íŠ¸ ê¸ˆì§€`;

/**
 * Netlify ì„œë²„ í•¨ìˆ˜ë¡œ ìš”ì²­ì„ ë³´ë‚´ê³  ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„° í•¨ìˆ˜ì…ë‹ˆë‹¤.
 * @param {object} body - Netlify í•¨ìˆ˜ë¡œ ë³´ë‚¼ ìš”ì²­ ë³¸ë¬¸ (JSON)
 * @returns {AsyncGenerator&lt;object, void, unknown&gt;} - { text: "..." } í˜•íƒœì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°
 */
async function* streamResponseFromServer(body) {
    try {
        const response = await fetch('/api/gemini', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
        });

        if (!response.ok || !response.body) {
            const errorData = await response.json().catch(() => ({ error: `ì„œë²„ ì˜¤ë¥˜: ${response.status}` }));
            throw new Error(errorData.error || `ì„œë²„ì—ì„œ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) {
                break;
            }
            // ì›ë˜ SDKì˜ ìŠ¤íŠ¸ë¦¼ ì²­í¬ì™€ ìœ ì‚¬í•œ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            yield { text: decoder.decode(value, { stream: true }) };
        }
    } catch (error) {
        console.error("Netlify í•¨ìˆ˜ fetch ì˜¤ë¥˜:", error);
        // UIì— í‘œì‹œë  ìˆ˜ ìˆë„ë¡ ì˜¤ë¥˜ ë©”ì‹œì§€ ì²­í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        yield { text: `\n[ì˜¤ë¥˜: ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.]` };
    }
}



/**
 * ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ì„¤ëª…ì„ ìƒì„±í•˜ê¸° ìœ„í•´ Netlify í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 * @param {string} base64Image - Base64ë¡œ ì¸ì½”ë”©ëœ ì´ë¯¸ì§€ ë°ì´í„°
 * @returns {AsyncGenerator&lt;object, void, unknown&gt;} - { text: "..." } í˜•íƒœì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°
 */
export function generateDescriptionStream(base64Image) {
    const systemInstruction = localStorage.getItem('customImagePrompt') || DEFAULT_IMAGE_PROMPT;
    console.log('ğŸ” [í”„ë¡¬í”„íŠ¸í™•ì¸] ì‚¬ìš©ì¤‘ì¸ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸:', systemInstruction.substring(0, 50) + '...');
    
    const requestBody = {
        base64Image,
        prompt: "ì´ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  í•œêµ­ì–´ë¡œ ìƒìƒí•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.",
        systemInstruction
    };
    
    return streamResponseFromServer(requestBody);
}

/**
 * í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê³  ë‹µë³€ì„ ìƒì„±í•˜ê¸° ìœ„í•´ Netlify í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 * @param {string} prompt - ì‚¬ìš©ìì˜ í…ìŠ¤íŠ¸ ì§ˆë¬¸
 * @returns {AsyncGenerator&lt;object, void, unknown&gt;} - { text: "..." } í˜•íƒœì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°
 */
export function generateTextStream(prompt) {
    const systemInstruction = localStorage.getItem('customTextPrompt') || DEFAULT_TEXT_PROMPT;
    console.log('ğŸ” [í”„ë¡¬í”„íŠ¸í™•ì¸] ì‚¬ìš©ì¤‘ì¸ í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸:', systemInstruction.substring(0, 50) + '...');
    
    const requestBody = {
        prompt,
        systemInstruction
    };
    
    return streamResponseFromServer(requestBody);
}
