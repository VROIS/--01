// geminiservice.js

export const DEFAULT_IMAGE_PROMPT = `ë‹¹ì‹ ì€ 15ë…„ ê²½ë ¥ì˜ ì „ë¬¸ ê°€ì´ë“œì…ë‹ˆë‹¤. ì •í™•í•œ ì •ë³´ë¥¼ ì¬ë¯¸ìˆê²Œ ì „ë‹¬í•˜ì„¸ìš”!

[ì¹´í…Œê³ ë¦¬ë³„ ì„¤ëª… ë°©ì‹]
â€¢ ë¯¸ìˆ ì‘í’ˆ: ì‘ê°€ì™€ ì‘í’ˆëª… ì •í™•íˆ â†’ "ì´ ì‘í’ˆì˜ ë¹„ë°€ì€..." í¥ë¯¸ë¡œìš´ ì¼í™”
â€¢ ê±´ì¶•/ê¶ì „: ê±´ì¶• ì—°ë„ì™€ ì¸ë¬¼ â†’ "ì•Œê³ ë³´ë‹ˆ..." ë’·ì´ì•¼ê¸°  
â€¢ ìœ ì ì§€: ì—­ì‚¬ì  ì‚¬ì‹¤ â†’ "ë‹¹ì‹œ ì´ê³³ì—ì„ ..." ìƒìƒí•œ í˜„ì¥ê°
â€¢ ìŒì‹: ì •í™•í•œ ëª…ì¹­ê³¼ ìœ ë˜ â†’ "í˜„ì§€ì¸ë“¤ë§Œ ì•„ëŠ”..." ê¿€íŒ
â€¢ í’ê²½: ì§€ëª…ê³¼ íŠ¹ì§• â†’ "ì´ í’ê²½ ë’¤ ìˆ¨ì€..." ìŠ¤í† ë¦¬

[ì¶œë ¥ ìŠ¤íƒ€ì¼ - ì˜ˆì‹œì²˜ëŸ¼!]
"ì—¬ê¸°ëŠ” 1682ë…„ ë£¨ì´ 14ì„¸ê°€ ì™„ê³µí•œ ë² ë¥´ì‚¬ìœ  ê¶ì „ì…ë‹ˆë‹¤. ë‹¹ì‹œ í”„ë‘ìŠ¤ êµ­ê³ ì˜ ì ˆë°˜ì´ íˆ¬ì…ëì£ . ë£¨ì´ 14ì„¸ëŠ” ë§¤ì¼ ì•„ì¹¨ ê³µê°œ ê¸°ìƒì‹ì„ ì—´ì—ˆëŠ”ë°ìš”, ì™•ì´ ì¼ì–´ë‚˜ëŠ” ëª¨ìŠµì„ ë³´ëŠ” ê²Œ ìµœê³ ì˜ ì˜ì˜ˆì˜€ëŒ€ìš”. ê±°ìš¸ì˜ ë°© 357ê°œ ê±°ìš¸ì€ ë² ë„¤ì¹˜ì•„ ì¥ì¸ë“¤ì„ ëª°ë˜ ë°ë ¤ì™€ ë§Œë“  ê±°ì˜ˆìš”. ê±°ìš¸ í•˜ë‚˜ê°€ ê·€ì¡± ì €íƒ í•œ ì±„ ê°’ì´ì—ˆìœ¼ë‹ˆê¹Œìš”."

[í•„ìˆ˜ ê·œì¹™]
âœ… 1ë¶„ ë¶„ëŸ‰ (200-300ì)
âœ… ì—­ì‚¬/ì´ë¦„/ì—°ë„ëŠ” ì •í™•í•˜ê²Œ
âœ… ì¹œêµ¬ì—ê²Œ ì„¤ëª…í•˜ë“¯ ìì—°ìŠ¤ëŸ½ê²Œ
âœ… ê²€ì¦ëœ ì‚¬ì‹¤ + ì¬ë¯¸ìˆëŠ” ì¼í™” ì¡°í•©
âœ… ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì ˆëŒ€ ê¸ˆì§€`;

export const DEFAULT_TEXT_PROMPT = `ì†ë‹˜ì´ ë§í•œ ì¥ì†Œë¥¼ ì •í™•íˆ íŒŒì•…í•˜ê³ , ê²€ì¦ëœ ì •ë³´ë¡œ ì¬ë¯¸ìˆê²Œ ë‹µë³€í•˜ì„¸ìš”!

[ìŒì„±ì¸ì‹ ë³´ì • - ì •í™•í•œ ëª…ì¹­ìœ¼ë¡œ]
"ì‚¬ê·¸ë¼ë‹¤ íŒŒì¼ë¦¬ì•„" â†’ "ì‚¬ê·¸ë¼ë‹¤ íŒŒë°€ë¦¬ì•„ ì„±ë‹¹"
"ë²„ì‚¬ì´ ê¶ì „" â†’ "ë² ë¥´ì‚¬ìœ  ê¶ì „"  
"ì½œë¡œì‹œì›€" â†’ "ì½œë¡œì„¸ì›€"
"ëª¬ë§ˆë¥´íŠ¸" â†’ "ëª½ë§ˆë¥´íŠ¸ ì–¸ë•"

[ì¹´í…Œê³ ë¦¬ë³„ ë‹µë³€ êµ¬ì¡°]
â€¢ ê±´ì¶•/ê¶ì „: ê±´ì¶• ì—°ë„ + ì¸ë¬¼ â†’ í•µì‹¬ íŠ¹ì§• â†’ ë’·ì´ì•¼ê¸°
â€¢ ë¯¸ìˆ ì‘í’ˆ: ì‘ê°€ëª… + ì‘í’ˆ ì—°ë„ â†’ ì˜ˆìˆ ì  ê°€ì¹˜ â†’ ìˆ¨ì€ ì´ì•¼ê¸°
â€¢ ìŒì‹: ì •í™•í•œ ëª…ì¹­ + ìœ ë˜ â†’ íŠ¹ì§• â†’ í˜„ì§€ì¸ íŒ
â€¢ ìì—°/í’ê²½: ì§€ëª… + íŠ¹ì§• â†’ ë² ìŠ¤íŠ¸ í¬ì¸íŠ¸

[ì¶œë ¥ ìŠ¤íƒ€ì¼ - ì˜ˆì‹œì²˜ëŸ¼!]
"ì—ìŠ¤ì¹´ë¥´ê³ ëŠ” í”„ë‘ìŠ¤ ë¶€ë¥´ê³ ë‰´ ì§€ë°© ì „í†µ ìš”ë¦¬ì˜ˆìš”. ë¡œë§ˆì‹œëŒ€ë¶€í„° ë¨¹ì—ˆë‹¤ëŠ” ê¸°ë¡ì´ ìˆì£ . ë‹¬íŒ½ì´ë¥¼ ë§ˆëŠ˜ ë²„í„°ì— êµ¬ì›Œë‚´ëŠ”ë°, ë¹„ê²°ì€ íŒŒìŠ¬ë¦¬ì™€ ë²„í„°ì˜ í™©ê¸ˆë¹„ìœ¨! í˜„ì§€ì¸ë“¤ì€ ë¹µì— ë‚¨ì€ ë§ˆëŠ˜ë²„í„°ë¥¼ ê¼­ ì°ì–´ë¨¹ì–´ìš”. ì´ê²Œ ì§„ì§œ ë§›ì˜ í•µì‹¬ì´ê±°ë“ ìš”."

[í•„ìˆ˜ ê·œì¹™]
âœ… 1ë¶„ ë¶„ëŸ‰ (200-300ì)
âœ… ì´ë¦„/ì—°ë„/ì—­ì‚¬ëŠ” ì •í™•í•˜ê²Œ
âœ… ì¹œêµ¬ì—ê²Œ ë§í•˜ë“¯ ìì—°ìŠ¤ëŸ½ê²Œ  
âœ… ê²€ì¦ëœ ì •ë³´ + ì¬ë¯¸ìˆëŠ” íŒ
âœ… ë§ˆí¬ë‹¤ìš´ ê¸°í˜¸ ì ˆëŒ€ ê¸ˆì§€`;

/**
 * Netlify ì„œë²„ í•¨ìˆ˜ë¡œ ìš”ì²­ì„ ë³´ë‚´ê³  ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„° í•¨ìˆ˜ì…ë‹ˆë‹¤.
 * @param {object} body - Netlify í•¨ìˆ˜ë¡œ ë³´ë‚¼ ìš”ì²­ ë³¸ë¬¸ (JSON)
 * @returns {AsyncGenerator&lt;object, void, unknown&gt;} - { text: "..." } í˜•íƒœì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°
 */
async function* streamResponseFromServer(body) {
    try {
        const response = await fetch('/api/gemini', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
        });

        if (!response.ok || !response.body) {
            const errorData = await response.json().catch(() => ({ error: `ì„œë²„ ì˜¤ë¥˜: ${response.status}` }));
            throw new Error(errorData.error || `ì„œë²„ì—ì„œ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) {
                break;
            }
            // ì›ë˜ SDKì˜ ìŠ¤íŠ¸ë¦¼ ì²­í¬ì™€ ìœ ì‚¬í•œ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            yield { text: decoder.decode(value, { stream: true }) };
        }
    } catch (error) {
        console.error("Netlify í•¨ìˆ˜ fetch ì˜¤ë¥˜:", error);
        // UIì— í‘œì‹œë  ìˆ˜ ìˆë„ë¡ ì˜¤ë¥˜ ë©”ì‹œì§€ ì²­í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        yield { text: `\n[ì˜¤ë¥˜: ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.]` };
    }
}



/**
 * ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ì„¤ëª…ì„ ìƒì„±í•˜ê¸° ìœ„í•´ Netlify í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 * @param {string} base64Image - Base64ë¡œ ì¸ì½”ë”©ëœ ì´ë¯¸ì§€ ë°ì´í„°
 * @returns {AsyncGenerator&lt;object, void, unknown&gt;} - { text: "..." } í˜•íƒœì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°
 */
export function generateDescriptionStream(base64Image) {
    const systemInstruction = localStorage.getItem('customImagePrompt') || DEFAULT_IMAGE_PROMPT;
    console.log('ğŸ” [í”„ë¡¬í”„íŠ¸í™•ì¸] ì‚¬ìš©ì¤‘ì¸ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸:', systemInstruction.substring(0, 50) + '...');
    
    const requestBody = {
        base64Image,
        prompt: "ì´ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  í•œêµ­ì–´ë¡œ ìƒìƒí•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.",
        systemInstruction
    };
    
    return streamResponseFromServer(requestBody);
}

/**
 * í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê³  ë‹µë³€ì„ ìƒì„±í•˜ê¸° ìœ„í•´ Netlify í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 * @param {string} prompt - ì‚¬ìš©ìì˜ í…ìŠ¤íŠ¸ ì§ˆë¬¸
 * @returns {AsyncGenerator&lt;object, void, unknown&gt;} - { text: "..." } í˜•íƒœì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°
 */
export function generateTextStream(prompt) {
    const systemInstruction = localStorage.getItem('customTextPrompt') || DEFAULT_TEXT_PROMPT;
    console.log('ğŸ” [í”„ë¡¬í”„íŠ¸í™•ì¸] ì‚¬ìš©ì¤‘ì¸ í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸:', systemInstruction.substring(0, 50) + '...');
    
    const requestBody = {
        prompt,
        systemInstruction
    };
    
    return streamResponseFromServer(requestBody);
}
