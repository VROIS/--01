// geminiservice.js

export const DEFAULT_IMAGE_PROMPT = `ë‹¹ì‹ ì€ ì „ë¬¸ ì—¬í–‰ ê°€ì´ë“œì…ë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ ë³´ê³  í•œêµ­ì–´ë¡œ ìƒì„¸í•œ ì„¤ëª…ì„ ì œê³µí•˜ì„¸ìš”.

[ì‘ì„± ê·œì¹™]
â€¢ ì¸ì‚¬ë§, ë§ˆë¬´ë¦¬ ë©˜íŠ¸ ì—†ì´ ë°”ë¡œ í•µì‹¬ ì„¤ëª… ì‹œì‘
â€¢ 400-500ì ë¶„ëŸ‰ìœ¼ë¡œ ì¶©ë¶„í•œ ì—­ì‚¬ì  ë°°ê²½ê³¼ ë§¥ë½ í¬í•¨
â€¢ í¥ë¯¸ë¡œìš´ ì¼í™”ë‚˜ ë¹„í™”ê°€ ìˆìœ¼ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ì¶”ê°€
â€¢ ì—°ë„ê°€ ë‚˜ì˜¤ë©´ í•œêµ­ì˜ ë™ì‹œëŒ€ ìƒí™©ê³¼ ë¹„êµ (ì˜ˆ: "1710ë…„ ì™„ê³µ, ë‹¹ì‹œ í•œêµ­ì€ ìˆ™ì¢… ì‹œëŒ€")
â€¢ ì •í™•í•œ ì •ë³´ ì „ë‹¬ì´ ìµœìš°ì„ , ì¬ë¯¸ëŠ” ìì—°ìŠ¤ëŸ½ê²Œ

[ê¸ˆì§€ ì‚¬í•­]
â€¢ "ì•ˆë…•í•˜ì„¸ìš”", "ì—¬ëŸ¬ë¶„", "ì‚¬ë‘í•˜ëŠ” ì—¬í–‰ê°" ê°™ì€ ì¸ì‚¬ë§
â€¢ "ë°©ë¬¸í•´ë³´ì„¸ìš”", "ì¶”ì²œí•©ë‹ˆë‹¤" ê°™ì€ ë§ˆë¬´ë¦¬ ë©˜íŠ¸
â€¢ ê³¼ì¥ë˜ê±°ë‚˜ ê°€ë²¼ìš´ í‘œí˜„

[ì˜ˆì‹œ í†¤]
"ì´ê³³ì€ ë² ë¥´ì‚¬ìœ  ê¶ì „ì˜ ì™•ì‹¤ ì˜ˆë°°ë‹¹ìœ¼ë¡œ, 1689ë…„ ì°©ê³µí•´ 1710ë…„ ì™„ê³µëìŠµë‹ˆë‹¤. ë‹¹ì‹œ í•œêµ­ì´ ìˆ™ì¢… ì‹œëŒ€ì˜€ì£ . ë£¨ì´ 14ì„¸ê°€ ê±´ì¶•ì— íˆ¬ì…í•œ ë¹„ìš©ì€ ë‹¹ëŒ€ í”„ë‘ìŠ¤ ê·€ì¡± 100ëª…ì´ 1ë…„ê°„ ìƒí™œí•  ìˆ˜ ìˆëŠ” ë§‰ëŒ€í•œ ê¸ˆì•¡ì´ì—ˆìŠµë‹ˆë‹¤. ì²œì¥ì˜ í”„ë ˆìŠ¤ì½”í™”ëŠ” í”„ë‘ìˆ˜ì•„ ë¥´ë¬´ì•ˆì˜ 'ì˜ê´‘ì˜ ì‚¼ìœ„ì¼ì²´'ë¡œ, í•˜ëŠ˜ì—ì„œ ë‚´ë ¤ì˜¤ëŠ” ë¹›ì„ í‘œí˜„í•œ ë°”ë¡œí¬ ì–‘ì‹ì˜ ê±¸ì‘ì…ë‹ˆë‹¤. í¥ë¯¸ë¡œìš´ ì ì€ 1ì¸µì€ ì™•ì˜ ì „ìš© ê³µê°„ì´ê³  2ì¸µì€ ê·€ì¡±ë“¤ì„ ìœ„í•œ ìë¦¬ì˜€ë‹¤ëŠ” ê²ƒì¸ë°, ì´ëŠ” ê±´ì¶•ì„ í†µí•´ì„œë„ ì—„ê²©í•œ ì‹ ë¶„ ì§ˆì„œë¥¼ ë“œëŸ¬ë‚¸ ê²ƒì…ë‹ˆë‹¤."`;

export const DEFAULT_TEXT_PROMPT = `ë‹¹ì‹ ì€ ì „ë¬¸ ì—¬í–‰ ê°€ì´ë“œì…ë‹ˆë‹¤. ìŒì„±ìœ¼ë¡œ ì…ë ¥ëœ í…ìŠ¤íŠ¸ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒì„¸í•œ ì„¤ëª…ì„ ì œê³µí•˜ì„¸ìš”.

[ìŒì„±ì¸ì‹ ë³´ì •]
"ì‚¬ê·¸ë¼ë‹¤ íŒŒì¼ë¦¬ì•„" â†’ "ì‚¬ê·¸ë¼ë‹¤ íŒŒë°€ë¦¬ì•„ ì„±ë‹¹"
"ë²„ì‚¬ì´ ê¶ì „" â†’ "ë² ë¥´ì‚¬ìœ  ê¶ì „"
"ì½œë¡œì‹œì›€" â†’ "ì½œë¡œì„¸ì›€"

[ì‘ì„± ê·œì¹™]
â€¢ ì¸ì‚¬ë§, ë§ˆë¬´ë¦¬ ë©˜íŠ¸ ì—†ì´ ë°”ë¡œ í•µì‹¬ ì„¤ëª… ì‹œì‘
â€¢ 400-500ì ë¶„ëŸ‰ìœ¼ë¡œ ì¶©ë¶„í•œ ë°°ê²½ ì •ë³´ì™€ ì‹¤ìš©ì  íŒ í¬í•¨
â€¢ ì—­ì‚¬ë‚˜ ìœ ë˜ê°€ ìˆìœ¼ë©´ ìì—°ìŠ¤ëŸ½ê²Œ ì¶”ê°€
â€¢ í˜„ì§€ì¸ ê¿€íŒì´ë‚˜ ì£¼ì˜ì‚¬í•­ì´ ìˆìœ¼ë©´ í¬í•¨
â€¢ ì •í™•í•œ ì •ë³´ ì „ë‹¬ì´ ìµœìš°ì„ 

[ê¸ˆì§€ ì‚¬í•­]
â€¢ "ì•ˆë…•í•˜ì„¸ìš”", "ì—¬ëŸ¬ë¶„" ê°™ì€ ì¸ì‚¬ë§
â€¢ "ë°©ë¬¸í•´ë³´ì„¸ìš”", "ì¶”ì²œí•©ë‹ˆë‹¤" ê°™ì€ ë§ˆë¬´ë¦¬ ë©˜íŠ¸
â€¢ ê³¼ì¥ë˜ê±°ë‚˜ ê°€ë²¼ìš´ í‘œí˜„

[ì˜ˆì‹œ í†¤]
"ì—ìŠ¤ì¹´ë¥´ê³ ëŠ” í”„ë‘ìŠ¤ì˜ ëŒ€í‘œì ì¸ ì‹ìš© ë‹¬íŒ½ì´ ìš”ë¦¬ë¡œ, ì£¼ë¡œ ë¶€ë¥´ê³ ë‰´ ì§€ë°©ì—ì„œ ë‚˜ëŠ” íŠ¹ë³„í•œ ë‹¬íŒ½ì´ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ë¡œë§ˆ ì‹œëŒ€ë¶€í„° ê·€ì¡±ë“¤ì˜ ë³„ë¯¸ì˜€ë˜ ì´ ìš”ë¦¬ëŠ” ì§€ê¸ˆë„ ê³ ê¸‰ ë ˆìŠ¤í† ë‘ì—ì„œ í•œ ì ‘ì‹œì— 3-4ë§Œì› ì •ë„ í•©ë‹ˆë‹¤. ë‹¬íŒ½ì´ ìì²´ë³´ë‹¤ëŠ” ë§ˆëŠ˜, íŒŒìŠ¬ë¦¬, ë²„í„°ë¡œ ë§Œë“  ì—ìŠ¤ì¹´ë¥´ê³  ë²„í„°ì˜ í’ë¯¸ê°€ í•µì‹¬ì…ë‹ˆë‹¤. ì²˜ìŒ ë“œì‹¤ ë•ŒëŠ” ì „ìš© ì§‘ê²Œì™€ í¬í¬ ì‚¬ìš©ì´ ì–´ìƒ‰í•  ìˆ˜ ìˆì§€ë§Œ, ë‹¬íŒ½ì´ë¥¼ ë‹¤ ë¨¹ì€ í›„ ë‚¨ì€ ë²„í„°ì— ë¹µì„ ì°ì–´ ë¨¹ëŠ” ê²ƒì´ í˜„ì§€ì¸ë“¤ì˜ ë°©ì‹ì…ë‹ˆë‹¤."`;

/**
 * Netlify ì„œë²„ í•¨ìˆ˜ë¡œ ìš”ì²­ì„ ë³´ë‚´ê³  ìŠ¤íŠ¸ë¦¬ë° ì‘ë‹µì„ ì²˜ë¦¬í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„° í•¨ìˆ˜ì…ë‹ˆë‹¤.
 * @param {object} body - Netlify í•¨ìˆ˜ë¡œ ë³´ë‚¼ ìš”ì²­ ë³¸ë¬¸ (JSON)
 * @returns {AsyncGenerator&lt;object, void, unknown&gt;} - { text: "..." } í˜•íƒœì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°
 */
async function* streamResponseFromServer(body) {
    try {
        const response = await fetch('/api/gemini', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(body),
        });

        if (!response.ok || !response.body) {
            const errorData = await response.json().catch(() => ({ error: `ì„œë²„ ì˜¤ë¥˜: ${response.status}` }));
            throw new Error(errorData.error || `ì„œë²„ì—ì„œ ì‘ë‹µì„ ë°›ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`);
        }

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { done, value } = await reader.read();
            if (done) {
                break;
            }
            // ì›ë˜ SDKì˜ ìŠ¤íŠ¸ë¦¼ ì²­í¬ì™€ ìœ ì‚¬í•œ ê°ì²´ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
            yield { text: decoder.decode(value, { stream: true }) };
        }
    } catch (error) {
        console.error("Netlify í•¨ìˆ˜ fetch ì˜¤ë¥˜:", error);
        // UIì— í‘œì‹œë  ìˆ˜ ìˆë„ë¡ ì˜¤ë¥˜ ë©”ì‹œì§€ ì²­í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
        yield { text: `\n[ì˜¤ë¥˜: ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.]` };
    }
}



/**
 * ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  ì„¤ëª…ì„ ìƒì„±í•˜ê¸° ìœ„í•´ Netlify í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 * @param {string} base64Image - Base64ë¡œ ì¸ì½”ë”©ëœ ì´ë¯¸ì§€ ë°ì´í„°
 * @returns {AsyncGenerator&lt;object, void, unknown&gt;} - { text: "..." } í˜•íƒœì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°
 */
export function generateDescriptionStream(base64Image) {
    const systemInstruction = localStorage.getItem('customImagePrompt') || DEFAULT_IMAGE_PROMPT;
    console.log('ğŸ” [í”„ë¡¬í”„íŠ¸í™•ì¸] ì‚¬ìš©ì¤‘ì¸ ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸:', systemInstruction.substring(0, 50) + '...');
    
    const requestBody = {
        base64Image,
        prompt: "ì´ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ê³  í•œêµ­ì–´ë¡œ ìƒìƒí•˜ê²Œ ì„¤ëª…í•´ì£¼ì„¸ìš”.",
        systemInstruction
    };
    
    return streamResponseFromServer(requestBody);
}

/**
 * í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ë¥¼ ì²˜ë¦¬í•˜ê³  ë‹µë³€ì„ ìƒì„±í•˜ê¸° ìœ„í•´ Netlify í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
 * @param {string} prompt - ì‚¬ìš©ìì˜ í…ìŠ¤íŠ¸ ì§ˆë¬¸
 * @returns {AsyncGenerator&lt;object, void, unknown&gt;} - { text: "..." } í˜•íƒœì˜ ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ë¹„ë™ê¸° ì œë„ˆë ˆì´í„°
 */
export function generateTextStream(prompt) {
    const systemInstruction = localStorage.getItem('customTextPrompt') || DEFAULT_TEXT_PROMPT;
    console.log('ğŸ” [í”„ë¡¬í”„íŠ¸í™•ì¸] ì‚¬ìš©ì¤‘ì¸ í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸:', systemInstruction.substring(0, 50) + '...');
    
    const requestBody = {
        prompt,
        systemInstruction
    };
    
    return streamResponseFromServer(requestBody);
}
